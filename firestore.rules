
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user has contributed to a product
    function hasContributed(productId) {
      let productData = get(/databases/$(database)/documents/products/$(productId)).data;
      return request.auth.uid in productData.contributions.map(c => c.vendorId);
    }

    match /users/{userId} {
      // Allow users to read their own profile
      allow read: if request.auth.uid == userId;
      // Allow users to update their own profile, but not their rating
      allow update: if request.auth.uid == userId && !('supplierRating' in request.resource.data);
      // Allow anyone to create their user document on signup
      allow create: if request.auth.uid == userId;
    }

    match /products/{productId} {
      // Anyone can read products
      allow read: if true;
      // Only authenticated users can create products
      allow create: if request.auth.uid != null;
      // Only the supplier who owns the product can update or delete it
      allow update, delete: if resource.data.supplierId == request.auth.uid;
    }
    
    match /products/{productId}/reviews/{reviewId} {
      // Anyone can read reviews
      allow read: if true;
      
      // Allow a user to create a review IF:
      // 1. They are authenticated.
      // 2. They have contributed to this specific product.
      // 3. The review data being submitted is valid.
      allow create: if request.auth.uid != null &&
                      hasContributed(productId) &&
                      request.resource.data.vendorId == request.auth.uid &&
                      request.resource.data.rating > 0 &&
                      request.resource.data.rating <= 5;
    }
  }
}
